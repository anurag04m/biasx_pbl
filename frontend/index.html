<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bias Detection Tool</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>üîç Bias Detection Tool</h1>

    <!-- Message Container -->
    <div id="message-container"></div>

    <!-- API Configuration Section -->
    <div class="section">
      <h3>API Configuration</h3>
      <p class="muted">
        Backend API: <strong id="api-url"></strong><br>
        To use a different backend, add <code>?api=https://your-backend-url</code> to the page URL.
      </p>
    </div>

    <!-- Upload Section -->
    <div class="section">
      <h2>1. Upload Dataset</h2>
      <div class="form-group">
        <label for="dataset-file">Select Original Dataset CSV:</label>
        <input type="file" id="dataset-file" accept=".csv">
      </div>
      <button id="upload-btn">Upload Dataset</button>
      <div id="session-info" class="session-info hidden">
        Session ID: <strong id="session-id"></strong>
      </div>
    </div>

    <!-- Upload Prediction Dataset Section (for Model Bias Detection) -->
    <div id="prediction-upload-section" class="section hidden">
      <h2>1b. Upload Prediction Dataset (Required for Model Bias Detection)</h2>
      <p class="muted">
        Upload a CSV file containing model predictions. This file should include:
        <br>‚Ä¢ Same rows as the original dataset (or an ID column to match)
        <br>‚Ä¢ Predicted labels column (e.g., y_pred, prediction)
        <br>‚Ä¢ Optional: Prediction probabilities column
      </p>
      <div class="form-group">
        <label for="prediction-file">Select Prediction CSV:</label>
        <input type="file" id="prediction-file" accept=".csv">
      </div>
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="id-col">ID Column (optional, for matching rows):</label>
            <select id="id-col">
              <option value="">-- None (use row order) --</option>
            </select>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="pred-label-col">Predicted Label Column:</label>
            <select id="pred-label-col"></select>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="pred-proba-col">Prediction Probability Column (optional):</label>
            <select id="pred-proba-col">
              <option value="">-- None --</option>
            </select>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="proba-threshold">Probability Threshold:</label>
            <input type="number" id="proba-threshold" value="0.5" min="0" max="1" step="0.1">
          </div>
        </div>
      </div>
      <button id="upload-prediction-btn">Upload Prediction Dataset</button>
      <div id="prediction-info" class="session-info hidden">
        ‚úì Prediction dataset uploaded
      </div>
    </div>

    <!-- Analysis Section -->
    <div id="analysis-section" class="section hidden">
      <h2>2. Analyze Bias</h2>

      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="detection-type">Detection Type:</label>
            <select id="detection-type">
              <option value="Dataset Bias Detection">Dataset Bias Detection</option>
              <option value="Model Bias Detection">Model Bias Detection</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="protected-attr">Protected Attribute:</label>
            <select id="protected-attr"></select>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="label-col">Label Column:</label>
            <select id="label-col"></select>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="form-group">
            <label for="priv-val">Privileged Value:</label>
            <select id="priv-val"></select>
          </div>
        </div>
        <div class="col">
          <div class="form-group">
            <label for="unpriv-val">Unprivileged Value:</label>
            <select id="unpriv-val"></select>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Select Metrics:</label>
        <div id="metrics-container" class="metrics-grid">
          <!-- Metrics checkboxes will be populated here -->
        </div>
      </div>

      <button id="analyze-btn">Run Analysis</button>

      <!-- Analysis Results -->
      <div id="analysis-results" class="hidden">
        <h3>Analysis Results</h3>
        <div class="result-box">
          <pre id="results-json" style="max-height: 200px; overflow-y: auto; display: none;"></pre> <!-- Hidden by default, maybe toggleable? Or just show charts -->
          
          <!-- Visualizations -->
          <div class="row">
            <div class="col">
               <div id="viz-group-distribution"></div>
            </div>
            <div class="col">
               <div id="viz-fairness-dashboard"></div>
            </div>
          </div>
          
          <div id="viz-metric-comparison" style="margin-top: 20px;"></div>
          
          <h4 style="margin-top: 30px;">Detailed Metrics</h4>
          <div id="viz-detailed-metrics" class="metrics-grid"></div>
        </div>

        <div id="suggestion-box" class="suggestion-box hidden">
          <h4>üí° Mitigation Suggestion</h4>
          <p id="suggestion-text"></p>
        </div>
      </div>
    </div>

    <!-- Mitigation Section -->
    <div id="mitigation-section" class="section hidden">
      <h2>3. Apply Mitigation</h2>

      <div class="form-group">
        <label for="mitigation-method">Mitigation Method:</label>
        <select id="mitigation-method">
          <option value="reweighing">Reweighing</option>
          <option value="disparate_impact_remover">Disparate Impact Remover</option>
          <option value="optimized_preprocessing">Optimized Preprocessing</option>
        </select>
      </div>

      <div class="form-group" id="repair-level-group" style="display:none;">
        <label for="repair-level">Repair Level (for Disparate Impact Remover):</label>
        <input type="number" id="repair-level" min="0" max="1" step="0.01" value="1.0">
        <p class="muted">Range: 0.0 to 1.0 (1.0 = full repair)</p>
      </div>

      <button id="mitigate-btn">Apply Mitigation</button>
      <button id="clear-btn" class="secondary">Clear Results</button>
      <button id="model-mitigate-btn" class="secondary">Mitigate Model (Frontend Only)</button>

      <!-- Mitigation Results -->
      <div id="mitigation-results" class="hidden">
        <h3>Mitigation Results</h3>
        <div class="result-box">
          <div id="viz-mitigation-comparison"></div>
          
          <div style="margin-top: 20px;">
             <h4>Raw Results (JSON)</h4>
             <pre id="mitigation-json" style="max-height: 200px; overflow-y: auto;"></pre>
          </div>
        </div>
      </div>

      <!-- Download Section -->
      <div id="download-section" class="hidden">
        <h3>Download Mitigated Dataset</h3>
        <p>
          <a id="download-link" href="#" target="_blank" download>
            <button>üì• Download CSV</button>
          </a>
        </p>
      </div>
    </div>

    <!-- Footer -->

  </div>

  <!-- Load JavaScript -->
  <script src="js/api.js"></script>
  <script src="js/visualization.js"></script>
  <script src="js/app.js"></script>

  <script>
    // Show/hide repair level based on method selection
    document.getElementById('mitigation-method').addEventListener('change', (e) => {
      const repairGroup = document.getElementById('repair-level-group');
      if (e.target.value === 'disparate_impact_remover') {
        repairGroup.style.display = 'block';
      } else {
        repairGroup.style.display = 'none';
      }
    });
  </script>
</body>
</html>
